# レートババ抜き (Rate Babanuki)

オンラインで遊べるレート制ババ抜きゲームです。ランキングシステム搭載で、友達や世界中のプレイヤーと競い合えます。

## 🎮 特徴

- **リアルタイムマルチプレイ** - Socket.IOによる同期対戦
- **レートシステム** - 勝敗に応じてレートが変動
- **CPUプレイヤー** - 人が足りない時は自動追加
- **ランキング機能** - トッププレイヤーを確認可能
- **履歴管理** - 過去のゲーム履歴を保存
- **カスタムルームID** - 友達と簡単に同じ部屋に参加

## 🛠️ 技術スタック

- **フロントエンド**: Next.js 15, React, TypeScript, Framer Motion, TailwindCSS
- **バックエンド**: Next.js API Routes, Socket.IO
- **データベース**: SQLite (Bun SQLite)
- **ランタイム**: Bun
- **スタイリング**: TailwindCSS

## 📋 必要条件

- [Bun](https://bun.sh/) v1.0以降

## 🚀 セットアップ

```bash
# リポジトリをクローン
git clone <repository-url>
cd レートババ抜き

# 依存関係をインストール
bun install

# 開発サーバーを起動
bun run dev
```

サーバーが起動したら、ブラウザで `http://localhost:3000` にアクセスしてください。

## 🐳 デプロイ（Docker / Coolify）

### Docker Composeでデプロイ

```bash
# イメージをビルド
docker-compose build

# コンテナを起動
docker-compose up -d

# ログを確認
docker-compose logs -f

# 停止
docker-compose down
```

### Coolifyでのデプロイ

1. **リポジトリを接続**
   - GitHub/GitLabリポジトリをCoolifyに接続

2. **ビルド設定**
   - Build Pack: **Docker Compose**
   - Port: **3000**

3. **環境変数（オプション）**
   ```
   NODE_ENV=production
   PORT=3000
   ```

4. **ボリューム設定（重要！）**
   - SQLiteデータベースの永続化のため、以下のボリュームを設定：
   ```
   ./data:/app/data
   ```

5. **デプロイ**
   - 「Deploy」ボタンをクリックして開始

### 注意事項

- **データベースの永続化**: `./data`ディレクトリをボリュームマウントすることで、コンテナを再起動してもデータが保持されます
- **WebSocket対応**: Socket.IOが正しく動作するよう、プロキシ設定でWebSocketを有効にしてください
- **ポート**: デフォルトは3000ですが、環境変数`PORT`で変更可能です

## 🎯 使い方

### ゲームを始める

1. **ホーム画面で名前を入力**
   - 最大10文字まで入力できます

2. **ルームを作成または参加**
   - **CREATE**: 新しいルームを作成
     - ルームIDを指定するか、自動生成させます
   - **JOIN**: 既存のルームに参加
     - ルームIDを入力して参加

3. **ロビーで準備**
   - 必要に応じてCPUプレイヤーを追加
   - 全員が揃ったら「START GAME」をクリック

### ゲームの進行

1. **カードを配る**
   - ゲーム開始時に全カードが均等に配られます
   - 同じ数字のペアは自動的に捨てられます

2. **カードを引く**
   - 自分のターンになったら、他のプレイヤーのカードを1枚選んで引きます
   - 引いたカードがペアになれば自動的に捨てられます
   - 30秒以内に引かないとランダムで引かれます

3. **勝敗**
   - 手札がなくなったプレイヤーから順に上がり
   - 最後までジョーカーを持っていた人が負け

### ランキングを見る

- ホーム画面の「🏆 TOP PLAYERS」ボタンをクリック
- レート順にトップ20プレイヤーが表示されます

## 📊 レートシステム

### 初期レート
- 全プレイヤーは **100** からスタート

### レート変動ルール

#### 1回目のゲーム
順位に応じて固定ポイント：
- 1位: **+4**
- 2位: **+3**
- 3位: **+2**
- 4位: **+1**
- 5位: **0**
- 6位: **0**

#### 2回目以降
```
基本変動 = (前回の順位 - 今回の順位) × 8
```

**同順位ボーナス**: 前回と同じ順位なら **+10**

**例:**
- 前回3位 → 今回1位: `(3-1) × 8 = +16`
- 前回2位 → 今回4位: `(2-4) × 8 = -16`
- 前回1位 → 今回1位: `0 + 10 = +10`

### レート補正

**高レート補正（レート130以上）**
- 獲得レートが **0.8倍** になります
- 例: +20 → +16

**低レート補正（レート70以下）**
- 獲得レートが **1.2倍** になります
- 例: +10 → +12

**最低レート**: **30**（これ以下には下がりません）

## 🎲 ゲーム機能詳細

### CPUプレイヤー
- ロビーで「ADD CPU」ボタンをクリックして追加
- CPUは自動的にカードを引きます
- 人間プレイヤーと同じルールでプレイ

### 履歴機能
- Recent Roomsから過去のルームに再参加可能
- 最新5件まで保存されます

### カードシャッフル
- 手札のカードをシャッフルできます（見た目のみ）
- 他のプレイヤーには影響しません

## 🔧 開発者向け

### プロジェクト構成

```
src/
├── app/                  # Next.js App Router
│   ├── api/             # API Routes
│   └── room/            # ゲームルームページ
├── components/          # Reactコンポーネント
│   └── game/           # ゲーム関連コンポーネント
├── lib/                # ビジネスロジック
│   ├── GameManager.ts  # ゲーム状態管理
│   └── rating.ts       # レート計算
├── hooks/              # カスタムフック
├── types/              # TypeScript型定義
└── db/                 # データベース
```

### データベーススキーマ

**players**
- `id`: プレイヤーID (UUID)
- `name`: 名前
- `rate`: レート
- `matches`: 試合数
- `wins`: 勝利数

**game_results**
- ゲーム結果の履歴

**player_history**
- プレイヤーごとのレート変動履歴

### ビルド

```bash
# 本番ビルド
bun run build

# 本番サーバー起動
bun run start
```

## 📝 ライセンス

このプロジェクトは個人用です。

## 👤 作者

**SATO TAKUMI**
- Website: [s-t.work](https://s-t.work)

---

**楽しいゲームを！🎴**
